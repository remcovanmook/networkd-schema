import os
import argparse
import sys

# Reusing styles from generate_html.py for consistency
CSS_STYLES = """
:root {
    --bg-color: #0f111a;
    --text-color: #c9d1d9;
    --heading-color: #58a6ff;
    --link-color: #58a6ff;
    --code-bg: #161b22;
    --border-color: #30363d;
    --accent-color: #238636;
    --meta-color: #8b949e;
    --font-main: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

body {
    background-color: var(--bg-color);
    color: var(--text-color);
    font-family: var(--font-main);
    line-height: 1.6;
    margin: 0;
    padding: 0;
    display: flex;
    justify-content: center;
    min-height: 100vh;
}

.container {
    max-width: 800px;
    width: 100%;
    padding: 40px 20px;
}

h1 { 
    color: var(--heading-color); 
    border-bottom: 1px solid var(--border-color); 
    padding-bottom: 20px; 
    margin-bottom: 30px;
    text-align: center;
}

.hero {
    background: #151920;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 30px;
    margin-bottom: 40px;
    text-align: center;
    box-shadow: 0 4px 20px rgba(0,0,0,0.4);
}

.hero h2 { margin-top: 0; color: #fff; }
.hero p { color: var(--meta-color); font-size: 1.1em; }

.btn {
    display: inline-block;
    background: var(--accent-color);
    color: #fff;
    padding: 12px 24px;
    border-radius: 6px;
    font-weight: bold;
    text-decoration: none;
    margin-top: 20px;
    transition: background 0.2s;
}
.btn:hover { background: #2ea043; text-decoration: none; }

.versions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.version-card {
    background: var(--code-bg);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 10px;
    text-align: center;
    transition: border-color 0.2s, transform 0.2s;
}
.version-card:hover { border-color: var(--link-color); transform: translateY(-2px); }
.version-card a { display: block; font-weight: bold; color: var(--text-color); text-decoration: none; }
.version-card a:hover { color: var(--heading-color); }

footer {
    margin-top: 50px;
    text-align: center;
    color: var(--meta-color);
    font-size: 0.9em;
    border-top: 1px solid var(--border-color);
    padding-top: 20px;
}
"""

def generate_version_index(output_dir, version):
    html = f"""<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Systemd Network Documentation - {version}</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <div class="container">
        <h1>Systemd Network Documentation ({version})</h1>
        
        <div class="hero">
            <h2>Configuration Manuals</h2>
            <p>Interactive reference documentation for {version}.</p>
        </div>

        <div class="versions-grid">
            <div class="version-card"><a href="systemd.network.html">systemd.network</a></div>
            <div class="version-card"><a href="systemd.netdev.html">systemd.netdev</a></div>
            <div class="version-card"><a href="systemd.link.html">systemd.link</a></div>
            <div class="version-card"><a href="networkd.conf.html">networkd.conf</a></div>
        </div>
        
        <div style="margin-top: 40px; text-align: center;">
            <a href="types.html" class="btn" style="background: var(--code-bg); border: 1px solid var(--border-color);">View Types Reference</a>
        </div>
        
        <footer>
            <p><a href="../index.html">&larr; Back to Versions</a></p>
            <p>Generated by <a href="https://github.com/remcovanmook/networkd-schema" target="_blank">networkd-schema project</a>.</p>
        </footer>
    </div>
</body>
</html>
"""
    ver_dir = os.path.join(output_dir, version)
    if os.path.exists(ver_dir):
        with open(os.path.join(ver_dir, "index.html"), "w") as f:
            f.write(html)
        print(f"Generated index for {version}")

def generate_schemas_index(output_dir, versions, clean_versions):
    latest_ver = clean_versions[0] if clean_versions else "unknown"
    
    # New location: docs/html/browse/
    browse_dir = os.path.join(output_dir, "browse")
    if not os.path.exists(browse_dir):
        os.makedirs(browse_dir)

    html = f"""<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Systemd Network JSON Schemas</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <div class="container">
        <h1>Systemd Network JSON Schemas</h1>
        
        <div class="hero">
            <h2>Latest Schemas</h2>
            <p>Canonical JSON schemas for systemd version <strong>{latest_ver}</strong>.</p>
            <a href="../schemas/{latest_ver}/systemd.network.schema.json" class="btn">View Latest Network Schema</a>
        </div>

        <h3>All Schema Versions</h3>
        <p>Raw JSON schema directories for all supported systemd versions.</p>
        <div class="versions-grid">
            {''.join([f'<div class="version-card"><a href="{v}/">{v}</a></div>' for v in clean_versions])}
        </div>
        
        <footer>
            <p><a href="../index.html">&larr; Back to Documentation</a></p>
            <p>Generated by <a href="https://github.com/remcovanmook/networkd-schema" target="_blank">networkd-schema project</a>.</p>
        </footer>
    </div>
</body>
</html>
"""
    with open(os.path.join(browse_dir, "index.html"), "w") as f:
        f.write(html)
    print(f"Generated schemas browser index at {os.path.join(browse_dir, 'index.html')}")

    # Generate index for each version folder inside browse/
    # We still need to list files from docs/html/schemas/ (where they reside)
    schemas_dir = os.path.join(output_dir, "schemas")
    
    for v in clean_versions:
        # Source dir to read files from
        v_schema_dir = os.path.join(schemas_dir, v)
        
        # Dest dir for HTML index
        v_browse_dir = os.path.join(browse_dir, v)
        if not os.path.exists(v_browse_dir):
             os.makedirs(v_browse_dir)

        if not os.path.exists(v_schema_dir): continue
        
        # List files
        try:
            files = [f for f in os.listdir(v_schema_dir) if f.endswith('.json')]
            files.sort()
        except FileNotFoundError:
            continue
            
        v_html = f"""<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Systemd Network Schemas - {v}</title>
    <link rel="stylesheet" href="../../css/style.css">
</head>
<body>
    <div class="container">
        <h1>Schemas for {v}</h1>
        <p><a href="../index.html">&larr; Back to Schemas Index</a></p>
        
        <div class="versions-grid">
            {''.join([f'<div class="version-card"><a href="../../schemas/{v}/{f}">{f}</a></div>' for f in files])}
        </div>
        
        <div class="hero" style="margin-top: 40px;">
             <p>Use these raw JSON schemas for validation or integration.</p>
        </div>
        
        <footer>
            <p>Generated by <a href="https://github.com/remcovanmook/networkd-schema" target="_blank">networkd-schema project</a>.</p>
        </footer>
    </div>
</body>
</html>
"""
        with open(os.path.join(v_browse_dir, "index.html"), "w") as f:
            f.write(v_html)
        print(f"Generated schema listing for {v} in browse/")

def generate_index(output_dir, versions, force=False):
    # Sort versions: latest first (numeric descending)
    # Filter out 'latest' string if present in list to avoid dupe, but create specific card
    
    clean_versions = []
    for v in versions:
        if v == 'latest': continue
        if v.startswith('v'):
            clean_versions.append(v)
    
    # Sort descending
    try:
        clean_versions.sort(key=lambda x: int(x[1:]), reverse=True)
    except:
        clean_versions.sort(reverse=True) # Fallback lexicographical
        
    latest_ver = clean_versions[0] if clean_versions else "unknown"

    html = f"""<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Systemd Network Documentation</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <h1>Systemd Network Documentation</h1>
        
        <p style="text-align: center; font-size: 1.2em; color: #8b949e; margin-bottom: 40px;">
            Enhanced interactive documentation and strictly typed JSON schemas for systemd's network configuration files.
            <br>
            <span style="font-size: 0.9em;">(Type-Aware &middot; Version-Controlled &middot; Hybrid Generation)</span>
        </p>
        
        <div class="hero">
            <h2>Latest Documentation</h2>
            <p>Interactive manuals for version <strong>{latest_ver}</strong>.</p>
            <a href="latest/" class="btn">Read Latest Docs</a>
        </div>
        
        <div style="text-align: center; margin-bottom: 50px;">
            <h3>JSON Schemas</h3>
            <p>Strict schemas for validation and tooling integration.</p>
            <a href="browse/" class="btn" style="background: #1f6feb;">Browse Schemas</a>
        </div>

        <h3>Documentation Archive</h3>
        <p>Manuals for previous systemd releases.</p>
        <div class="versions-grid">
            {''.join([f'<div class="version-card"><a href="{v}/">{v}</a></div>' for v in clean_versions])}
        </div>
        
        <footer>
            <p>Generated by <a href="https://github.com/remcovanmook/networkd-schema" target="_blank">networkd-schema project</a>.</p>
        </footer>
    </div>
</body>
</html>
"""
    
    out_path = os.path.join(output_dir, "index.html")
    write = True
    if not force and os.path.exists(out_path):
         try:
             with open(out_path, 'r') as f:
                 if f.read() == html:
                     write = False
                     print(f"Skipping {out_path} (unchanged)")
         except: pass
         
    if write:
        with open(out_path, "w") as f:
            f.write(html)
        print(f"Generated landing page at {out_path}")
    
    # Also generate Schema Index
    generate_schemas_index(output_dir, versions, clean_versions)

if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("--out", required=True)
    parser.add_argument("--versions", nargs="+", required=True)
    parser.add_argument("--force", action="store_true", help="Force overwrite")
    args = parser.parse_args()
    
    generate_index(args.out, args.versions, force=args.force)
